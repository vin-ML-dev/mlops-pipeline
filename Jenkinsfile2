pipeline {
 
    agent {
    docker {
          image 'jupyter/scipy-notebook'
          args '-u root:root'
          reuseNode true
      }    
    }
    
    environment {
         CONTAINER_NAME = "my-model"
    }
     
    stages {
        
          
            stage('Preprocessing stage') {
            steps {
                   sh 'apt-get update'
                   sh 'apt install docker.io -y'
                   sh 'docker --version'
                   sh 'service docker restart'

                   sh 'python3 preprocessing.py'
                   echo "Data prepared"
               }
           }
           stage('Training stage') {
            steps {
                    sh 'python3 train.py'
                    echo "model trained"
                }
        }
        stage('Test stage') {
              steps {
                   
                    sh 'python3 test.py'
                    }
               }
               
        stage('build docker image') {
            
            steps {
               sh "docker build -t mlops-demo-jenkins ."
               
                }
        }
        
        stage('Run docker image'){
         steps {
              sh 'docker stop $CONTAINER_NAME || true'
              sh 'docker rm $CONTAINER_NAME || true'
              sh 'docker run -p 5000:5000 --name $CONTAINER_NAME  mlops-demo-jenkins'
              
         }
         
        }
    }
}
